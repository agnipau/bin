#!/usr/bin/env bash
#
# Similiar to wal-set-dark and wal-set-light but I use this for some serious
# colorschemes.

# Generate an sh file containing the variables.
gen_themes_sh() {
  # Store the colors into variables.
  color0="$(xrdb -query  | rg "color0"  | awk '{ print $2 }')"
  color1="$(xrdb -query  | rg "color1"  | head -n1 | awk '{ print $2 }')"
  color2="$(xrdb -query  | rg "color2"  | awk '{ print $2 }')"
  color3="$(xrdb -query  | rg "color3"  | awk '{ print $2 }')"
  color4="$(xrdb -query  | rg "color4"  | awk '{ print $2 }')"
  color5="$(xrdb -query  | rg "color5"  | awk '{ print $2 }')"
  color6="$(xrdb -query  | rg "color6"  | awk '{ print $2 }')"
  color7="$(xrdb -query  | rg "color7"  | awk '{ print $2 }')"
  color8="$(xrdb -query  | rg "color8"  | awk '{ print $2 }')"
  color9="$(xrdb -query  | rg "color9"  | awk '{ print $2 }')"
  color10="$(xrdb -query | rg "color10" | awk '{ print $2 }')"
  color11="$(xrdb -query | rg "color11" | awk '{ print $2 }')"
  color12="$(xrdb -query | rg "color12" | awk '{ print $2 }')"
  color13="$(xrdb -query | rg "color13" | awk '{ print $2 }')"
  color14="$(xrdb -query | rg "color14" | awk '{ print $2 }')"
  color15="$(xrdb -query | rg "color15" | awk '{ print $2 }')"

  # Generate a file containing the color variables usable with bash.
  cat <<EOF > "${HOME}/progetti/themes/sh/colors.sh"
#!/usr/bin/env bash
#
# File generated by theme-set.

background='$color0'
foreground='$color7'
cursor='$color7'

color0='$color0'
color1='$color1'
color2='$color2'
color3='$color3'
color4='$color4'
color5='$color5'
color6='$color6'
color7='$color7'
color8='$color8'
color9='$color9'
color10='$color10'
color11='$color11'
color12='$color12'
color13='$color13'
color14='$color14'
color15='$color15'

# FZF colors.
export FZF_DEFAULT_OPTS="
  \$FZF_DEFAULT_OPTS
  --color fg:13,hl:1,fg+:1,bg+:0,hl+:7
  --color info:0,prompt:1,spinner:1,pointer:1,marker:1
"
EOF

  # Generate a file containing the color variables usable with fish.
  cat <<EOF > "${HOME}/progetti/themes/sh/colors.fish"
#!/usr/bin/env fish
#
# File generated by theme-set.

set background '$color0'
set foreground '$color7'
set cursor     '$color7'

set color0             '$color0'
set color1             '$color1'
set color2             '$color2'
set color3             '$color3'
set color4             '$color4'
set color5             '$color5'
set color6             '$color6'
set color7             '$color7'
set color8             '$color8'
set color9             '$color9'
set color10            '$color10'
set color11            '$color11'
set color12            '$color12'
set color13            '$color13'
set color14            '$color14'
set color15            '$color15'

# FZF colors.
set -x FZF_DEFAULT_OPTS "
  \$FZF_DEFAULT_OPTS
  --color fg:13,hl:1,fg+:1,bg+:0,hl+:7
  --color info:0,prompt:1,spinner:1,pointer:1,marker:1
"
EOF
}

# Reorder some files.
reorder_files() {
  # tmux.
  cp "${HOME}/.tmux.conf.themes" "${HOME}/.tmux.conf"
}

# Fix the fish shell config file.
fix_fish() {
  # shellcheck disable=SC2016
  sed -i -e 's/# Source .*/# Source themes colors./' \
         -e 's_^\. .*_\. $HOME/progetti/themes/sh/colors.fish_' \
         "${HOME}/.config/fish/config.fish"
}

# Change the value for some highlight groups.
restyle_fish() {
  sed -i -e "s/fish_color_autosuggestion    .*/fish_color_autosuggestion    ${color13:1:6}/" \
         -e "s/fish_pager_color_progress    .*/fish_pager_color_progress    ${color0:1:6}/" \
         -e "s/fish_pager_color_description .*/fish_pager_color_description ${color8:1:6}/" \
         "${HOME}/.config/fish/config.fish"
}

# Apply colors to dunst.
restyle_dunst() {
  killall -9 dunst
  dunst \
    -lb "$color0" \
    -nb "$color0" \
    -cb "$color1" \
    -lf "$color7" \
    -nf "$color7" \
    -cf "$color0" \
    -lfr "$color0" \
    -nfr "$color0" \
    -cfr "$color1" &
}

# Fix the zathura config file.
fix_zathura() {
  sed -i -e 's/# Source .*/# Source themes colors\./' \
         -e 's_include .*_include "/home/matte/altri\_progetti/zathura/colors.zathura"_' \
         "${HOME}/.config/zathura/zathurarc"
}

# Generate a theme for zathura.
restyle_zathura() {
  cat <<EOF >"${HOME}/progetti/themes/zathura/colors-zathura"
set default-bg              "$color0"
set default-fg              "$color7"
set highlight-color         "$color13"
set highlight-active-color  "$color1"
set completion-bg           "$color0"
set completion-fg           "$color13"
set completion-highlight-bg "$color0"
set completion-highlight-fg "$color1"
set statusbar-bg            "$color1"
set statusbar-fg            "$color0"
set inputbar-bg             "$color0"
set inputbar-fg             "$color7"
EOF
}

# Apply the colors to my OpenBox theme.
restyle_openbox() {
  sed -i -e "s/bg.color:       #.*/bg.color:       ${color0}/" \
         -e "s/text.color:     #.*/text.color:     ${color7}/" \
         -e "s/image.color: #.*/image.color: ${color7}/" \
         -e "s/menu.items.bg.color:          #.*/menu.items.bg.color:          ${color0}/" \
         -e "s/menu.items.text.color:        #.*/menu.items.text.color:        ${color13}/" \
         -e "s/menu.items.active.bg.color:   #.*/menu.items.active.bg.color:   ${color0}/" \
         -e "s/menu.items.active.text.color: #.*/menu.items.active.text.color: ${color1}/" \
         -e "s/menu.border.color:            #.*/menu.border.color:            ${color0}/" \
         -e "s/menu.separator.color:         #.*/menu.separator.color:         ${color0}/" \
         "${HOME}/.themes/Samiero/openbox-3/themerc"
  openbox --reconfigure
}

# Set radius to rofi and apply some modifications to the colors.
restyle_rofi() {
  sed -i -e "s/^    active-foreground: #.*/    active-foreground: ${color13};/" \
         -e "s/^    normal-foreground: #.*/    normal-foreground: ${color13};/" \
         -e "s/^    urgent-foreground: #.*/    urgent-foreground: ${color13};/" \
         -e "s/^    alternate-active-foreground: #.*/    alternate-active-foreground: ${color13};/" \
         -e "s/^    alternate-normal-foreground: #.*/    alternate-normal-foreground: ${color13};/" \
         -e "s/^    alternate-urgent-foreground: #.*/    alternate-urgent-foreground: ${color13};/" \
         -e "s/^    selected-active-background: @.*/    selected-normal-background: @background;/" \
         -e "s/^    selected-active-foreground: #.*/    selected-normal-foreground: ${color1};/" \
         -e "s/^    selected-normal-background: @.*/    selected-normal-background: @background;/" \
         -e "s/^    selected-normal-foreground: #.*/    selected-normal-foreground: ${color1};/" \
         -e "s/^    selected-urgent-background: @.*/    selected-normal-background: @background;/" \
         -e "s/^    selected-urgent-foreground: #.*/    selected-normal-foreground: ${color1};/" \
         -e "s/^    background: #.*/    background: ${color0};/" \
         -e "s/^    foreground: #.*/    foreground: ${color7};/" \
         "${HOME}/progetti/themes/rofi/colors-rofi.rasi"
}

# Change some color values for pqiv in rifle's rifle.conf config file.
restyle_rifle() {
  sed -i -e "s/--box-colors='#.*':'#.*'/--box-colors='${color7}':'${color0}'/" \
         "${HOME}/.config/ranger/rifle.conf"
}

# Change the alacritty colorscheme.
restyle_alacritty() {
  sed -i -e "s/background: '.*/background: '0x${color0:1:6}'/" \
         -e "s/foreground: '.*/foreground: '0x${color7:1:6}'/" \
         -e "s/text:   '.*/text:   '0x${color0:1:6}'/" \
         -e "s/cursor: '.*/cursor: '0x${color7:1:6}'/" \
         -e "s/black:   '.*/black:   '0x${color0:1:6}'/" \
         -e "s/red:     '.*/red:     '0x${color1:1:6}'/" \
         -e "s/green:   '.*/green:   '0x${color2:1:6}'/" \
         -e "s/yellow:  '.*/yellow:  '0x${color3:1:6}'/" \
         -e "s/blue:    '.*/blue:    '0x${color4:1:6}'/" \
         -e "s/magenta: '.*/magenta: '0x${color5:1:6}'/" \
         -e "s/cyan:    '.*/cyan:    '0x${color6:1:6}'/" \
         -e "s/white:   '.*/white:   '0x${color7:1:6}'/" \
         -e "s/black:    '.*/black:    '0x${color8:1:6}'/" \
         -e "s/red:      '.*/red:      '0x${color9:1:6}'/" \
         -e "s/green:    '.*/green:    '0x${color10:1:6}'/" \
         -e "s/yellow:   '.*/yellow:   '0x${color11:1:6}'/" \
         -e "s/blue:     '.*/blue:     '0x${color12:1:6}'/" \
         -e "s/magenta:  '.*/magenta:  '0x${color13:1:6}'/" \
         -e "s/cyan:     '.*/cyan:     '0x${color14:1:6}'/" \
         -e "s/white:    '.*/white:    '0x${color15:1:6}'/" \
         "${HOME}/.config/alacritty/alacritty.yml"
}

main() {
  gen_themes_sh
  # Source the freshly generated sh file.
  . "${HOME}/progetti/themes/sh/colors.sh"
  reorder_files
  fix_fish
  restyle_fish
  restyle_dunst
  fix_zathura
  restyle_zathura
  restyle_openbox
  restyle_rofi
  restyle_rifle
  restyle_alacritty
}

main
